<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsar — Architecture Diagram</title>
<style>
  :root {
    --bg: #0a0e17;
    --bg-layer: #0f1623;
    --bg-card: #111827;
    --bg-expanded: #0d1220;
    --border: #1e293b;
    --border-glow: #334155;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --text-bright: #f8fafc;
    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace;
    --sans: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    --cyan: #06b6d4;
    --blue: #3b82f6;
    --purple: #8b5cf6;
    --green: #10b981;
    --orange: #f59e0b;
    --red: #ef4444;
    --pink: #ec4899;
    --yellow: #eab308;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    line-height: 1.5;
    min-height: 100vh;
  }

  /* ── Header ──────────────────────────── */
  .header {
    text-align: center;
    padding: 28px 24px 16px;
  }
  .header h1 {
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--cyan), var(--blue), var(--purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .header p {
    color: var(--text-dim);
    font-size: 0.78rem;
    margin-top: 4px;
  }

  /* ── Diagram container ───────────────── */
  .diagram {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 20px 40px;
  }

  /* ── Flow connector ──────────────────── */
  .flow {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 24px;
    position: relative;
  }
  .flow-line {
    width: 2px;
    height: 100%;
    background: var(--border-glow);
    position: relative;
  }
  .flow-line::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: -3px;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 5px solid var(--border-glow);
  }
  .flow-label {
    position: absolute;
    left: calc(50% + 16px);
    font-size: 0.65rem;
    font-family: var(--mono);
    color: var(--text-dim);
    white-space: nowrap;
    opacity: 0.7;
  }

  /* ── Layer (collapsed row) ───────────── */
  .layer {
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg-layer);
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
  }
  .layer::before {
    content: '';
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 3px;
    background: var(--layer-color, var(--blue));
    border-radius: 10px 0 0 10px;
    opacity: 0.5;
    transition: opacity 0.25s;
  }
  .layer:hover { border-color: var(--border-glow); }
  .layer:hover::before { opacity: 1; }
  .layer.expanded {
    border-color: var(--border-glow);
    background: var(--bg-expanded);
    cursor: default;
  }
  .layer.expanded::before { opacity: 1; }
  .layer.planned {
    border-style: dashed;
    opacity: 0.65;
  }
  .layer.planned:hover { opacity: 0.85; }
  .layer.planned.expanded { opacity: 1; }

  /* ── Layer header (always visible) ───── */
  .layer-bar {
    display: grid;
    grid-template-columns: 24px 1fr auto auto;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    min-height: 44px;
  }
  .layer-num {
    font-size: 0.6rem;
    font-weight: 700;
    font-family: var(--mono);
    color: var(--layer-color, var(--blue));
    text-align: center;
    opacity: 0.7;
  }
  .layer-info {
    display: flex;
    flex-direction: column;
    gap: 1px;
    min-width: 0;
  }
  .layer-title {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text-bright);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .layer-title .planned-badge {
    font-size: 0.55rem;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 4px;
    background: rgba(234,179,8,0.15);
    color: var(--yellow);
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .layer-subtitle {
    font-size: 0.68rem;
    font-family: var(--mono);
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .layer-type-flow {
    font-size: 0.62rem;
    font-family: var(--mono);
    color: var(--text-dim);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .layer-type-flow .t {
    padding: 1px 6px;
    border-radius: 4px;
    background: rgba(255,255,255,0.05);
  }
  .layer-type-flow .arrow { color: var(--border-glow); }
  .layer-chevron {
    font-size: 0.9rem;
    color: var(--text-dim);
    transition: transform 0.3s;
    flex-shrink: 0;
    width: 20px;
    text-align: center;
  }
  .layer.expanded .layer-chevron { transform: rotate(90deg); }

  /* ── Layer detail (expanded) ─────────── */
  .layer-detail {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
  }
  .layer.expanded .layer-detail {
    max-height: 2000px;
  }
  .layer-content {
    padding: 0 14px 16px;
    border-top: 1px solid var(--border);
    margin-top: 0;
    padding-top: 14px;
  }

  /* ── Strategy switcher ─────────────── */
  .strategies {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
  }
  .strat-tab {
    font-size: 0.68rem;
    font-family: var(--mono);
    padding: 4px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.2s;
  }
  .strat-tab:hover {
    border-color: var(--border-glow);
    color: var(--text);
  }
  .strat-tab.active {
    background: rgba(255,255,255,0.06);
    border-color: var(--layer-color, var(--blue));
    color: var(--text-bright);
  }
  .strat-panel { display: none; }
  .strat-panel.active { display: block; }

  /* ── Code blocks ─────────────────────── */
  .proto-block {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    margin: 8px 0;
    font-family: var(--mono);
    font-size: 0.7rem;
    line-height: 1.7;
    overflow-x: auto;
  }
  .proto-block .kw { color: var(--pink); }
  .proto-block .ty { color: var(--cyan); }
  .proto-block .pr { color: var(--text); }
  .proto-block .fn { color: var(--green); }
  .proto-block .cm { color: #4a5568; font-style: italic; }
  .proto-block .st { color: var(--orange); }
  .proto-block .op { color: var(--text-dim); }

  /* ── Struct/data grid ──────────────── */
  .type-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 10px;
    margin: 10px 0;
  }
  .type-card {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
  }
  .type-card-title {
    font-size: 0.72rem;
    font-weight: 600;
    font-family: var(--mono);
    color: var(--text-bright);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .type-card-title .kind {
    font-size: 0.55rem;
    font-weight: 500;
    padding: 1px 5px;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .kind-struct   { background: rgba(6,182,212,0.15); color: var(--cyan); }
  .kind-protocol { background: rgba(139,92,246,0.15); color: var(--purple); }
  .kind-class    { background: rgba(59,130,246,0.15); color: var(--blue); }
  .kind-enum     { background: rgba(245,158,11,0.15); color: var(--orange); }
  .type-card .field {
    font-size: 0.65rem;
    font-family: var(--mono);
    color: var(--text-dim);
    padding: 1px 0;
    display: flex;
    gap: 4px;
  }
  .type-card .field .name { color: var(--text); }
  .type-card .field .sep  { color: var(--text-dim); }
  .type-card .field .type { color: var(--cyan); }

  /* ── Pipeline steps ──────────────────── */
  .pipe {
    display: flex;
    align-items: center;
    gap: 0;
    flex-wrap: wrap;
    margin: 8px 0;
  }
  .pipe-step {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 10px;
    font-size: 0.68rem;
    color: var(--text);
    white-space: nowrap;
  }
  .pipe-chev {
    color: var(--border-glow);
    font-size: 0.75rem;
    padding: 0 3px;
    flex-shrink: 0;
  }

  /* ── State machine ───────────────────── */
  .states {
    display: flex;
    align-items: center;
    gap: 0;
    flex-wrap: wrap;
    margin: 6px 0;
  }
  .state {
    padding: 4px 10px;
    border-radius: 14px;
    font-size: 0.65rem;
    font-weight: 500;
    font-family: var(--mono);
    white-space: nowrap;
  }
  .state-arr { padding: 0 5px; color: var(--text-dim); font-size: 0.75rem; }
  .s-idle   { background: rgba(148,163,184,0.12); color: #94a3b8; }
  .s-work   { background: rgba(59,130,246,0.15);  color: var(--blue); }
  .s-recv   { background: rgba(245,158,11,0.15);  color: var(--orange); }
  .s-ok     { background: rgba(16,185,129,0.15);  color: var(--green); }
  .s-err    { background: rgba(239,68,68,0.15);   color: var(--red); }

  /* ── Packet viz ──────────────────────── */
  .packet {
    display: flex;
    gap: 0;
    margin: 8px 0;
    font-size: 0.68rem;
  }
  .pkt-seg {
    padding: 6px 12px;
    text-align: center;
    border: 1px solid var(--border);
  }
  .pkt-seg:first-child { border-radius: 6px 0 0 6px; }
  .pkt-seg:last-child  { border-radius: 0 6px 6px 0; }
  .pkt-seg:not(:first-child) { border-left: none; }
  .pkt-seg .pkt-name { font-weight: 600; font-size: 0.68rem; }
  .pkt-seg .pkt-desc { font-size: 0.58rem; color: var(--text-dim); margin-top: 1px; }

  /* ── Misc ────────────────────────────── */
  .desc {
    font-size: 0.75rem;
    color: var(--text-dim);
    line-height: 1.6;
    margin-bottom: 10px;
  }
  .desc code {
    font-family: var(--mono);
    background: rgba(255,255,255,0.06);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 0.68rem;
    color: var(--cyan);
  }
  .tag {
    display: inline-block;
    font-size: 0.6rem;
    font-weight: 500;
    padding: 1px 7px;
    border-radius: 9999px;
    font-family: var(--mono);
    margin: 1px 1px;
  }
  .tag-cyan   { background: rgba(6,182,212,0.12); color: var(--cyan); }
  .tag-purple { background: rgba(139,92,246,0.12); color: var(--purple); }
  .tag-green  { background: rgba(16,185,129,0.12); color: var(--green); }
  .tag-orange { background: rgba(245,158,11,0.12); color: var(--orange); }
  .tag-blue   { background: rgba(59,130,246,0.12); color: var(--blue); }
  .tag-red    { background: rgba(239,68,68,0.12); color: var(--red); }
  .tag-dim    { background: rgba(255,255,255,0.04); color: var(--text-dim); }
  .sub-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    margin: 12px 0 6px;
  }
  .settings-tbl {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 2px 14px;
    font-size: 0.65rem;
    font-family: var(--mono);
    margin: 6px 0;
  }
  .settings-tbl .k { color: var(--cyan); }
  .settings-tbl .v { color: var(--text-dim); text-align: right; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  @media (max-width: 700px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .layer-type-flow { display: none; }
  }
  .branch-label {
    font-size: 0.6rem;
    font-family: var(--mono);
    color: var(--text-dim);
    opacity: 0.6;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
  }
  .branch-label .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
  }
  .branch-label .dot.wip {
    background: var(--orange);
  }
  .impl-note {
    font-size: 0.62rem;
    color: var(--text-dim);
    font-style: italic;
    margin-top: 6px;
  }
</style>
</head>
<body>

<div class="header">
  <h1>Pulsar Detection & Tracking Architecture</h1>
  <p>Code architecture & data flow &mdash; click any layer to expand</p>
</div>

<div class="diagram">

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L0: INPUT                                                 -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--pink);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">IN</div>
    <div class="layer-info">
      <div class="layer-title">Camera Capture</div>
      <div class="layer-subtitle">CameraService &rarr; PipelineProcessor &rarr; TrackManager</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">CVPixelBuffer</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--cyan);">FrameData</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">
    <div class="desc">
      <code>CameraService</code> manages <code>AVCaptureSession</code> with manual exposure/ISO control. Frames bridge to <code>PipelineProcessor</code> (background actor) which calls <code>TrackManager.processFrame()</code>.
      In Phase 5, <code>ARSession</code> will replace AVCapture to provide <code>cameraTransform</code>.
    </div>
    <div class="type-cards">
      <div class="type-card">
        <div class="type-card-title">FrameData <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">pixelBuffer</span><span class="sep">:</span><span class="type">CVPixelBuffer</span></div>
        <div class="field"><span class="name">timestamp</span><span class="sep">:</span><span class="type">TimeInterval</span></div>
        <div class="field"><span class="name">cameraTransform</span><span class="sep">:</span><span class="type">simd_float4x4?</span></div>
        <div class="impl-note">@unchecked Sendable &mdash; cameraTransform is nil until ARKit Phase 5</div>
      </div>
      <div class="type-card">
        <div class="type-card-title">PixelSample <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">channels</span><span class="sep">:</span><span class="type">[Float]</span></div>
        <div class="field"><span class="name">timestamp</span><span class="sep">:</span><span class="type">TimeInterval</span></div>
        <div class="impl-note">Sendable &mdash; RGB float values (0&ndash;1), used downstream by classifier</div>
      </div>
    </div>
  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label">FrameData</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L1: DETECTION                                             -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--cyan);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">1</div>
    <div class="layer-info">
      <div class="layer-title">Detection</div>
      <div class="layer-subtitle">protocol LEDDetector &rarr; ThresholdDetector</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">FrameData</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--cyan);">[LEDCandidate]</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="proto-block">
      <span class="kw">protocol</span> <span class="ty">LEDDetector</span> {<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">detect</span>(<span class="pr">in</span> frame: <span class="ty">FrameData</span>) -> [<span class="ty">LEDCandidate</span>]<br>
      }
    </div>

    <div class="sub-label">Strategy: ThresholdDetector</div>
    <div class="desc">
      GPU-accelerated CIFilter pipeline with CPU-side connected component labeling (union-find).
      VNDetectContoursRequest was <a href="#" style="color:var(--orange);text-decoration:none;cursor:default;">evaluated and rejected</a> &mdash; same thresholded input, higher latency.
    </div>

    <div class="pipe">
      <div class="pipe-step">Downsample 0.25x</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step">max(R,G,B)</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step">Median 3x3</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step">Threshold</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step">Morph Open</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step">CCL</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step">Shape Filter</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step">Color Sample</div>
    </div>

    <div class="type-cards">
      <div class="type-card">
        <div class="type-card-title">LEDCandidate <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">id</span><span class="sep">:</span><span class="type">UUID</span></div>
        <div class="field"><span class="name">centroid</span><span class="sep">:</span><span class="type">CGPoint</span></div>
        <div class="field"><span class="name">boundingBox</span><span class="sep">:</span><span class="type">CGRect</span></div>
        <div class="field"><span class="name">colorSample</span><span class="sep">:</span><span class="type">PixelSample</span></div>
        <div class="field"><span class="name">area</span><span class="sep">:</span><span class="type">Float</span></div>
        <div class="field"><span class="name">eccentricity</span><span class="sep">:</span><span class="type">Float</span></div>
        <div class="field"><span class="name">confidence</span><span class="sep">:</span><span class="type">Float</span></div>
        <div class="impl-note">Identifiable, Hashable, Sendable</div>
      </div>
      <div class="type-card">
        <div class="type-card-title">ThresholdDetector.Settings <span class="kind kind-struct">struct</span></div>
        <div class="settings-tbl">
          <span class="k">brightnessThreshold</span><span class="v">0.3</span>
          <span class="k">downsampleFactor</span><span class="v">0.25</span>
          <span class="k">thresholdMode</span><span class="v">.fixed | .otsu | .adaptive</span>
          <span class="k">morphRadius</span><span class="v">2.0</span>
          <span class="k">maxEccentricity</span><span class="v">0.85</span>
          <span class="k">minCandidateArea</span><span class="v">4 px</span>
          <span class="k">maxCandidateArea</span><span class="v">10,000 px</span>
          <span class="k">medianFilterEnabled</span><span class="v">true</span>
          <span class="k">morphCloseEnabled</span><span class="v">false</span>
        </div>
      </div>
    </div>

    <div class="sub-label">Internal: ComponentStats &rarr; Eccentricity</div>
    <div class="desc">
      CCL accumulates per-blob moments (<code>sumX, sumY, sumX2, sumY2, sumXY</code>). Eccentricity is computed from covariance matrix eigenvalues:
      <code>e = sqrt(1 - lambda_min / lambda_max)</code>. 0 = circle, 1 = line. Rejects <code>e > 0.85</code>.
      Color is sampled with brightness-weighted averaging &mdash; only pixels above threshold contribute, weighted by <code>max(R,G,B)</code>.
    </div>

  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label">[LEDCandidate]</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L2: NURSERY                                               -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--purple);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">2</div>
    <div class="layer-info">
      <div class="layer-title">Candidate Nursery</div>
      <div class="layer-subtitle">CandidateNursery.process(_:) &mdash; temporal noise gate</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">[LEDCandidate]</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--purple);">[LEDCandidate]</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="desc">
      Filters transient noise by requiring candidates to appear in <strong>N consecutive frames</strong> before promotion. Each incoming candidate matches the nearest "proto" within <code>matchDistance</code>. Unmatched protos are evicted after <code>lostFrames</code>.
    </div>

    <div class="proto-block">
      <span class="kw">struct</span> <span class="ty">CandidateNursery</span>: <span class="ty">Sendable</span> {<br>
      &nbsp;&nbsp;<span class="kw">mutating func</span> <span class="fn">process</span>(_ candidates: [<span class="ty">LEDCandidate</span>]) -> [<span class="ty">LEDCandidate</span>]<br>
      &nbsp;&nbsp;<span class="kw">mutating func</span> <span class="fn">reset</span>()<br>
      &nbsp;&nbsp;<span class="kw">var</span> <span class="pr">protoCount</span>: <span class="ty">Int</span> { <span class="kw">get</span> }<br>
      }
    </div>

    <div class="grid-2">
      <div class="type-card">
        <div class="type-card-title">CandidateNursery.Settings <span class="kind kind-struct">struct</span></div>
        <div class="settings-tbl">
          <span class="k">promotionFrames</span><span class="v">3</span>
          <span class="k">matchDistance</span><span class="v">30 px</span>
          <span class="k">lostFrames</span><span class="v">2</span>
          <span class="k">maxProtos</span><span class="v">30</span>
        </div>
      </div>
      <div class="type-card">
        <div class="type-card-title">Internal: ProtoCandidate <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">id</span><span class="sep">:</span><span class="type">UUID</span></div>
        <div class="field"><span class="name">position</span><span class="sep">:</span><span class="type">CGPoint</span></div>
        <div class="field"><span class="name">consecutiveFrames</span><span class="sep">:</span><span class="type">Int</span></div>
        <div class="field"><span class="name">framesLost</span><span class="sep">:</span><span class="type">Int</span></div>
      </div>
    </div>

    <div class="sub-label">Logic</div>
    <div class="desc">
      1. Match each candidate to closest proto within 30 px<br>
      2. Increment <code>consecutiveFrames</code> on match<br>
      3. Promote to output when count &ge; 3<br>
      4. Reset counter if proto was lost then reappears<br>
      5. Evict proto if absent > 2 frames<br>
      6. Cap protos at 30 (weakest evicted first)
    </div>

  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label">Promoted [LEDCandidate]</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L3: MATCHING                                              -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--purple);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">3</div>
    <div class="layer-info">
      <div class="layer-title">Track Matching</div>
      <div class="layer-subtitle">protocol TrackMatcher &rarr; SpatialHash | VisionFramework</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">[LEDCandidate]</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--purple);">MatchResult</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="proto-block">
      <span class="kw">protocol</span> <span class="ty">TrackMatcher</span> {<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">addTrack</span>(_ track: <span class="ty">Track</span>)<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">removeTrack</span>(id: <span class="ty">Track.ID</span>)<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">updateTrackPosition</span>(id: <span class="ty">Track.ID</span>, newPosition: <span class="ty">CGPoint</span>, newVelocity: <span class="ty">CGPoint</span>)<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">prepareForFrame</span>(_ frame: <span class="ty">FrameData</span>) <span class="cm">// default no-op</span><br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">match</span>(candidates: [<span class="ty">LEDCandidate</span>], frameDelta: <span class="ty">TimeInterval</span>) -> <span class="ty">MatchResult</span><br>
      }
    </div>

    <div class="type-cards">
      <div class="type-card">
        <div class="type-card-title">MatchResult <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">assignments</span><span class="sep">:</span><span class="type">[LEDCandidate.ID : Track.ID]</span></div>
        <div class="field"><span class="name">newCandidates</span><span class="sep">:</span><span class="type">[LEDCandidate]</span></div>
        <div class="field"><span class="name">lostTrackIDs</span><span class="sep">:</span><span class="type">Set&lt;Track.ID&gt;</span></div>
        <div class="impl-note">Sendable &mdash; drives the 3-way split in TrackManager</div>
      </div>
    </div>

    <div class="strategies" id="matcher-tabs">
      <button class="strat-tab active" onclick="switchStrat(this, 'matcher')">SpatialHashMatcher</button>
      <button class="strat-tab" onclick="switchStrat(this, 'matcher')">VisionTrackMatcher</button>
    </div>

    <!-- SpatialHashMatcher -->
    <div class="strat-panel active" data-group="matcher">
      <div class="desc">
        O(1) average-case grid lookup. Predicts each track's position using velocity, then queries nearby cells with an <strong>adaptive radius</strong> that widens for fast camera motion.
        Greedy closest-match assignment (one candidate per track).
      </div>
      <div class="grid-2">
        <div class="type-card">
          <div class="type-card-title">SpatialHashMatcher <span class="kind kind-class">class</span></div>
          <div class="field"><span class="name">grid</span><span class="sep">:</span><span class="type">SpatialHashGrid</span></div>
          <div class="field"><span class="name">tracks</span><span class="sep">:</span><span class="type">[Track.ID : Track]</span></div>
          <div class="impl-note">predicted = pos + vel * dt</div>
          <div class="impl-note">radius = min(maxR, base + speed * dt * mult)</div>
        </div>
        <div class="type-card">
          <div class="type-card-title">Settings <span class="kind kind-struct">struct</span></div>
          <div class="settings-tbl">
            <span class="k">cellSize</span><span class="v">100 px</span>
            <span class="k">maxMatchDistance</span><span class="v">50 px</span>
            <span class="k">velocityMultiplier</span><span class="v">1.5</span>
            <span class="k">maxSearchRadius</span><span class="v">200 px</span>
          </div>
        </div>
      </div>
      <div class="type-card" style="margin-top:10px;">
        <div class="type-card-title">SpatialHashGrid <span class="kind kind-class">class</span></div>
        <div class="desc" style="margin:0;">
          2D hash map: <code>GridKey{x,y}</code> &rarr; <code>[Track.ID]</code>. Methods: <code>insert()</code>, <code>findNearby(to:radius:)</code>, <code>position(for:)</code>, <code>clear()</code>.
        </div>
      </div>
    </div>

    <!-- VisionTrackMatcher -->
    <div class="strat-panel" data-group="matcher">
      <div class="desc">
        Uses Apple <code>VNTrackObjectRequest</code> for visual feature tracking. One <code>VNSequenceRequestHandler</code> per track.
        Falls back to <code>SpatialHashMatcher</code> internally for untracked candidates.
      </div>
      <div class="branch-label"><span class="dot wip"></span> Branch: claude/vision-framework-velocity-RcQUK</div>
      <div class="grid-2" style="margin-top:8px;">
        <div class="type-card">
          <div class="type-card-title">VisionTrackMatcher <span class="kind kind-class">class</span></div>
          <div class="field"><span class="name">visionTracks</span><span class="sep">:</span><span class="type">[Track.ID : VisionTrackState]</span></div>
          <div class="field"><span class="name">spatialMatcher</span><span class="sep">:</span><span class="type">SpatialHashMatcher</span></div>
          <div class="field"><span class="name">currentPixelBuffer</span><span class="sep">:</span><span class="type">CVPixelBuffer?</span></div>
          <div class="impl-note">prepareForFrame() stashes pixel buffer for VNRequests</div>
          <div class="impl-note">4 phases: Vision track &rarr; match to candidates &rarr; spatial fallback &rarr; merge</div>
        </div>
        <div class="type-card">
          <div class="type-card-title">Settings <span class="kind kind-struct">struct</span></div>
          <div class="settings-tbl">
            <span class="k">minTrackingConfidence</span><span class="v">Float</span>
            <span class="k">boundingBoxPadding</span><span class="v">Float</span>
            <span class="k">trackingLevel</span><span class="v">.fast | .accurate</span>
            <span class="k">useSpatialFallback</span><span class="v">true</span>
            <span class="k">fallbackMatchDistance</span><span class="v">CGFloat</span>
          </div>
        </div>
      </div>
      <div class="type-card" style="margin-top:10px;">
        <div class="type-card-title">VisionTrackState <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">handler</span><span class="sep">:</span><span class="type">VNSequenceRequestHandler</span></div>
        <div class="field"><span class="name">lastObservation</span><span class="sep">:</span><span class="type">VNDetectedObjectObservation?</span></div>
      </div>
    </div>

  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label">MatchResult { assignments, newCandidates, lostTrackIDs }</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L4: TRACK MANAGEMENT                                      -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--blue);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">4</div>
    <div class="layer-info">
      <div class="layer-title">Track Management</div>
      <div class="layer-subtitle">TrackManager.processFrame(_:) &mdash; orchestrator</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">MatchResult</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--blue);">[Track.ID : Track]</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="desc">
      Central orchestrator. Owns the detector, matcher, nursery, encoding strategy, and all active tracks. Each <code>processFrame()</code> call runs the full pipeline synchronously.
    </div>

    <div class="proto-block">
      <span class="kw">class</span> <span class="ty">TrackManager</span> {<br>
      &nbsp;&nbsp;<span class="kw">private let</span> <span class="pr">detector</span>: <span class="ty">LEDDetector</span><br>
      &nbsp;&nbsp;<span class="kw">private let</span> <span class="pr">matcher</span>: <span class="ty">TrackMatcher</span><br>
      &nbsp;&nbsp;<span class="kw">private let</span> <span class="pr">encodingStrategy</span>: <span class="ty">EncodingStrategy</span><br>
      &nbsp;&nbsp;<span class="kw">private let</span> <span class="pr">classifier</span>: <span class="ty">SymbolClassifier</span><br>
      &nbsp;&nbsp;<span class="kw">private let</span> <span class="pr">motionEstimator</span>: <span class="ty">MotionEstimator</span><br>
      &nbsp;&nbsp;<span class="kw">private var</span> <span class="pr">nursery</span>: <span class="ty">CandidateNursery</span><br>
      &nbsp;&nbsp;<span class="kw">public var</span> <span class="pr">activeTracks</span>: [<span class="ty">Track.ID</span> : <span class="ty">Track</span>]<br>
      <br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">processFrame</span>(_ frame: <span class="ty">FrameData</span>) <span class="cm">// runs full pipeline</span><br>
      }
    </div>

    <div class="sub-label">Per-Frame Pipeline</div>
    <div class="pipe">
      <div class="pipe-step" style="border-color:var(--cyan);">1. detect</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step" style="border-color:var(--purple);">2. nursery</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step" style="border-color:var(--purple);">3. match</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step" style="border-color:var(--green);">4. update matched</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step" style="border-color:var(--blue);">5. create new</div><div class="pipe-chev">&rsaquo;</div>
      <div class="pipe-step" style="border-color:var(--red);">6. gc lost</div>
    </div>

    <div class="grid-3" style="margin-top: 12px;">
      <div class="type-card">
        <div class="type-card-title" style="color:var(--green);">Step 4: Update Matched</div>
        <div class="desc" style="margin:0;">
          For each assignment: estimate velocity via <code>MotionEstimator</code>, classify color sample, feed symbol to per-track decoder.
        </div>
      </div>
      <div class="type-card">
        <div class="type-card-title" style="color:var(--blue);">Step 5: Create New</div>
        <div class="desc" style="margin:0;">
          Unmatched candidates become new tracks. Sorted by <code>confidence * (1-eccentricity)</code>. Each gets a fresh <code>SymbolDecoder</code>. Capped at <code>maxTracks</code>.
        </div>
      </div>
      <div class="type-card">
        <div class="type-card-title" style="color:var(--red);">Step 6: GC Lost</div>
        <div class="desc" style="margin:0;">
          Increment <code>framesLost</code> for unmatched tracks. Remove when <code>framesLost > lostThreshold</code> (30 frames).
        </div>
      </div>
    </div>

    <div class="sub-label">Motion Estimation</div>
    <div class="proto-block">
      <span class="kw">protocol</span> <span class="ty">MotionEstimator</span> {<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">estimateMotion</span>(track: <span class="ty">Track</span>, newPosition: <span class="ty">CGPoint</span>, frameDelta: <span class="ty">TimeInterval</span>) -> <span class="ty">CGPoint</span><br>
      }
    </div>
    <div class="grid-2">
      <div class="type-card">
        <div class="type-card-title">CentroidDeltaEstimator <span class="kind kind-struct">struct</span></div>
        <div class="impl-note">Simple: velocity = (newPos - oldPos) / dt</div>
      </div>
      <div class="type-card">
        <div class="type-card-title">SmoothedMotionEstimator <span class="kind kind-struct">struct</span></div>
        <div class="impl-note">EMA: smoothed = alpha * raw + (1-alpha) * prev &mdash; alpha=0.4</div>
      </div>
    </div>

    <div class="type-card" style="margin-top:10px;">
      <div class="type-card-title">TrackManager.Settings <span class="kind kind-struct">struct</span></div>
      <div class="settings-tbl">
        <span class="k">lostThreshold</span><span class="v">30 frames</span>
        <span class="k">maxTracks</span><span class="v">64</span>
        <span class="k">nurseryPromotionFrames</span><span class="v">3</span>
        <span class="k">nurseryMatchDistance</span><span class="v">30 px</span>
        <span class="k">nurseryLostFrames</span><span class="v">2</span>
        <span class="k">nurseryMaxProtos</span><span class="v">30</span>
      </div>
    </div>

  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label">Track (per-LED entity with decoder)</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L5: TRACK + CLASSIFICATION + DECODING                     -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--green);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">5</div>
    <div class="layer-info">
      <div class="layer-title">Per-Track Decoding</div>
      <div class="layer-subtitle">Track.processObservation &rarr; SymbolClassifier &rarr; SymbolDecoder</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">PixelSample</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--orange);">Symbol?</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--green);">DecodeResult</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="desc">
      Each <code>Track</code> holds its own <code>SymbolDecoder</code> instance. On each matched frame,
      the color sample is classified to a discrete <code>Symbol</code>, then fed to the decoder state machine.
    </div>

    <div class="type-cards">
      <div class="type-card">
        <div class="type-card-title">Track <span class="kind kind-class">class</span> <span class="tag tag-blue" style="font-size:0.5rem;">@Observable</span></div>
        <div class="field"><span class="name">id</span><span class="sep">:</span><span class="type">UUID</span></div>
        <div class="field"><span class="name">position</span><span class="sep">:</span><span class="type">CGPoint</span></div>
        <div class="field"><span class="name">velocity</span><span class="sep">:</span><span class="type">CGPoint</span></div>
        <div class="field"><span class="name">area</span><span class="sep">:</span><span class="type">Float</span></div>
        <div class="field"><span class="name">state</span><span class="sep">:</span><span class="type">TrackState</span></div>
        <div class="field"><span class="name">decoder</span><span class="sep">:</span><span class="type">any SymbolDecoder</span></div>
        <div class="field"><span class="name">symbolBuffer</span><span class="sep">:</span><span class="type">[SymbolSample]</span></div>
        <div class="field"><span class="name">stateHistory</span><span class="sep">:</span><span class="type">[StateTransition]</span></div>
        <div class="field"><span class="name">lastSeenTime</span><span class="sep">:</span><span class="type">TimeInterval</span></div>
        <div class="field"><span class="name">framesLost</span><span class="sep">:</span><span class="type">Int</span></div>
        <div class="field"><span class="name">decodedID</span><span class="sep">:</span><span class="type">UInt16?</span> <span style="color:var(--text-dim);font-size:0.6rem;">(computed)</span></div>
        <div style="margin-top:6px; font-size:0.65rem; font-family:var(--mono); color:var(--green);">
          func processObservation(sample: PixelSample, classifier: SymbolClassifier, timestamp: TimeInterval)
        </div>
      </div>
      <div class="type-card">
        <div class="type-card-title">Supporting Types</div>

        <div style="margin-top:6px; font-size:0.62rem; font-weight:600; color:var(--orange);">TrackState <span class="kind kind-enum">enum</span></div>
        <div class="field"><span class="name">.preambleSearch</span></div>
        <div class="field"><span class="name">.receiving</span><span class="sep">(</span><span class="type">symbolCount: Int</span><span class="sep">)</span></div>
        <div class="field"><span class="name">.decoded</span><span class="sep">(</span><span class="type">UInt16</span><span class="sep">)</span></div>
        <div class="field"><span class="name">.failed</span><span class="sep">(</span><span class="type">DecodeError</span><span class="sep">)</span></div>

        <div style="margin-top:8px; font-size:0.62rem; font-weight:600; color:var(--cyan);">SymbolSample <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">rawPixel</span><span class="sep">:</span><span class="type">PixelSample</span></div>
        <div class="field"><span class="name">classifiedSymbol</span><span class="sep">:</span><span class="type">Symbol?</span></div>
        <div class="field"><span class="name">timestamp</span><span class="sep">:</span><span class="type">TimeInterval</span></div>

        <div style="margin-top:8px; font-size:0.62rem; font-weight:600; color:var(--cyan);">StateTransition <span class="kind kind-struct">struct</span></div>
        <div class="field"><span class="name">timestamp</span><span class="sep">:</span><span class="type">TimeInterval</span></div>
        <div class="field"><span class="name">from</span><span class="sep">:</span><span class="type">TrackState</span></div>
        <div class="field"><span class="name">to</span><span class="sep">:</span><span class="type">TrackState</span></div>
        <div class="field"><span class="name">reason</span><span class="sep">:</span><span class="type">String</span></div>
      </div>
    </div>

  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label">PixelSample &rarr; Symbol? &rarr; DecodeResult</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L6: PROTOCOL / ENCODING STRATEGY                          -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--orange);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">6</div>
    <div class="layer-info">
      <div class="layer-title">Encoding Strategy</div>
      <div class="layer-subtitle">protocol EncodingStrategy &rarr; RGBDifferentialPhase</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">Symbol stream</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--green);">UInt16 LED ID</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="desc">
      Pluggable factory protocol. Each strategy produces its own encoder (TX side), classifier, and decoder (RX side).
      Currently one implementation: <strong>RGB Differential Phase</strong>.
    </div>

    <div class="proto-block">
      <span class="kw">protocol</span> <span class="ty">EncodingStrategy</span> {<br>
      &nbsp;&nbsp;<span class="kw">var</span> <span class="pr">name</span>: <span class="ty">String</span> { <span class="kw">get</span> }<br>
      &nbsp;&nbsp;<span class="kw">var</span> <span class="pr">calibrationSequence</span>: [<span class="ty">Symbol</span>] { <span class="kw">get</span> }<br>
      &nbsp;&nbsp;<span class="kw">var</span> <span class="pr">syncSymbol</span>: <span class="ty">Symbol</span> { <span class="kw">get</span> }<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">makeEncoder</span>() -> <span class="ty">SymbolEncoder</span><br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">makeClassifier</span>() -> <span class="ty">SymbolClassifier</span><br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">makeDecoder</span>() -> <span class="ty">SymbolDecoder</span><br>
      }
    </div>

    <div class="grid-3" style="margin-top:8px;">
      <div class="proto-block" style="margin:0;">
        <span class="kw">protocol</span> <span class="ty">SymbolEncoder</span> {<br>
        &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">encodePacket</span>(<br>
        &nbsp;&nbsp;&nbsp;&nbsp;ledID: <span class="ty">UInt16</span>,<br>
        &nbsp;&nbsp;&nbsp;&nbsp;ledCount: <span class="ty">UInt16</span><br>
        &nbsp;&nbsp;) -> [<span class="ty">Symbol</span>]<br>
        &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">color</span>(<br>
        &nbsp;&nbsp;&nbsp;&nbsp;for: <span class="ty">Symbol</span><br>
        &nbsp;&nbsp;) -> <span class="ty">LEDColor</span><br>
        }
      </div>
      <div class="proto-block" style="margin:0;">
        <span class="kw">protocol</span> <span class="ty">SymbolClassifier</span> {<br>
        &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">classify</span>(<br>
        &nbsp;&nbsp;&nbsp;&nbsp;sample: <span class="ty">PixelSample</span><br>
        &nbsp;&nbsp;) -> <span class="ty">Symbol?</span><br>
        &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">calibrate</span>(...)<br>
        &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">reset</span>()<br>
        }
      </div>
      <div class="proto-block" style="margin:0;">
        <span class="kw">protocol</span> <span class="ty">SymbolDecoder</span> {<br>
        &nbsp;&nbsp;<span class="kw">mutating func</span> <span class="fn">feed</span>(<br>
        &nbsp;&nbsp;&nbsp;&nbsp;_ symbol: <span class="ty">Symbol?</span><br>
        &nbsp;&nbsp;) -> <span class="ty">DecodeResult</span><br>
        &nbsp;&nbsp;<span class="kw">mutating func</span> <span class="fn">reset</span>()<br>
        }
      </div>
    </div>

    <div class="sub-label">Implementation: RGB Differential Phase</div>

    <div class="grid-2" style="margin-top:6px;">
      <div>
        <div class="type-card">
          <div class="type-card-title">Symbol <span class="kind kind-enum">enum</span></div>
          <div style="margin-top:4px;">
            <span class="tag tag-red">.red</span>
            <span class="tag tag-green">.green</span>
            <span class="tag tag-blue">.blue</span>
            <span class="tag tag-dim">.white</span>
            <span class="tag tag-dim">.bright</span>
            <span class="tag tag-dim">.dim</span>
            <span class="tag tag-dim">.unknown</span>
          </div>
        </div>
        <div class="type-card" style="margin-top:8px;">
          <div class="type-card-title">DecodeResult <span class="kind kind-enum">enum</span></div>
          <div class="states">
            <div class="state s-idle">.idle</div><div class="state-arr">&rarr;</div>
            <div class="state s-work">.calibrating</div><div class="state-arr">&rarr;</div>
            <div class="state s-work">.synced</div><div class="state-arr">&rarr;</div>
            <div class="state s-recv">.receiving(n)</div><div class="state-arr">&rarr;</div>
            <div class="state s-ok">.decoded(UInt16)</div>
          </div>
          <div style="margin-top:4px;margin-left:48px;">
            <span class="state-arr">&searr;</span>
            <span class="state s-err">.failed(DecodeError)</span>
          </div>
          <div class="impl-note">DecodeError: .crcMismatch | .timeout | .invalidHeader</div>
        </div>
      </div>
      <div>
        <div class="type-card">
          <div class="type-card-title">Packet Structure</div>
          <div class="packet">
            <div class="pkt-seg" style="background:rgba(148,163,184,0.08);">
              <div class="pkt-name" style="color:var(--text);">Preamble</div>
              <div class="pkt-desc">W R G B W</div>
            </div>
            <div class="pkt-seg" style="background:rgba(139,92,246,0.06);">
              <div class="pkt-name" style="color:var(--purple);">Sync</div>
              <div class="pkt-desc">W</div>
            </div>
            <div class="pkt-seg" style="background:rgba(59,130,246,0.06);">
              <div class="pkt-name" style="color:var(--blue);">Hdr</div>
              <div class="pkt-desc">4 bits</div>
            </div>
            <div class="pkt-seg" style="background:rgba(6,182,212,0.06); flex:1;">
              <div class="pkt-name" style="color:var(--cyan);">Address</div>
              <div class="pkt-desc">4&ndash;12 bits</div>
            </div>
            <div class="pkt-seg" style="background:rgba(16,185,129,0.06);">
              <div class="pkt-name" style="color:var(--green);">CRC</div>
              <div class="pkt-desc">4|8 bits</div>
            </div>
          </div>
          <div class="impl-note">Bits in color transitions: CW rotation = 1, CCW = 0</div>
          <div class="impl-note">Consecutive duplicate symbols are deduplicated (hold)</div>
        </div>
        <div class="type-card" style="margin-top:8px;">
          <div class="type-card-title">LEDColor <span class="kind kind-struct">struct</span></div>
          <div class="field"><span class="name">r</span><span class="sep">:</span><span class="type">Float</span></div>
          <div class="field"><span class="name">g</span><span class="sep">:</span><span class="type">Float</span></div>
          <div class="field"><span class="name">b</span><span class="sep">:</span><span class="type">Float</span></div>
        </div>
      </div>
    </div>

    <div class="type-card" style="margin-top:8px;">
      <div class="type-card-title">Supporting: PacketBuilder <span class="kind kind-enum">enum</span> &amp; CRC <span class="kind kind-enum">enum</span></div>
      <div class="desc" style="margin:0;">
        <code>PacketBuilder.buildPacket(ledID:crcBits:) &rarr; PacketBits</code> &mdash; variable-length address encoding (ceil(log2(id+1)) bits, padded to nibble).<br>
        <code>CRC.crc4(_:)</code> (poly 0x3 reflected) and <code>CRC.crc8(_:)</code> (poly 0x07).
      </div>
    </div>

  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label">TrackSnapshot (Sendable copy for UI)</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L7: OUTPUT                                                -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer" style="--layer-color: var(--blue);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">OUT</div>
    <div class="layer-info">
      <div class="layer-title">Output: Track Snapshots</div>
      <div class="layer-subtitle">TrackSnapshot &mdash; Sendable cross-actor bridge</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">Track</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--blue);">TrackSnapshot</span>
      <span class="arrow">&rarr;</span>
      <span class="t">@MainActor</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="desc">
      <code>Track</code> is <code>@Observable</code> but not <code>Sendable</code>. The pipeline runs on a background actor (<code>PipelineProcessor</code>).
      <code>TrackSnapshot</code> copies all relevant state into a <code>Sendable</code> struct for publishing to <code>@MainActor</code> SwiftUI views.
    </div>

    <div class="type-cards">
      <div class="type-card">
        <div class="type-card-title">TrackSnapshot <span class="kind kind-struct">struct</span> <span class="tag tag-blue" style="font-size:0.5rem;">Sendable</span></div>
        <div class="field"><span class="name">id</span><span class="sep">:</span><span class="type">UUID</span></div>
        <div class="field"><span class="name">position</span><span class="sep">:</span><span class="type">CGPoint</span></div>
        <div class="field"><span class="name">velocity</span><span class="sep">:</span><span class="type">CGPoint</span></div>
        <div class="field"><span class="name">area</span><span class="sep">:</span><span class="type">Float</span></div>
        <div class="field"><span class="name">state</span><span class="sep">:</span><span class="type">TrackState</span></div>
        <div class="field"><span class="name">symbolBuffer</span><span class="sep">:</span><span class="type">[SymbolSample]</span></div>
        <div class="field"><span class="name">stateHistory</span><span class="sep">:</span><span class="type">[StateTransition]</span></div>
        <div class="field"><span class="name">decodedID</span><span class="sep">:</span><span class="type">UInt16?</span></div>
        <div class="field"><span class="name">framesLost</span><span class="sep">:</span><span class="type">Int</span></div>
        <div style="margin-top:6px; font-size:0.65rem; font-family:var(--mono); color:var(--green);">
          init(from track: Track)
        </div>
      </div>
      <div class="type-card">
        <div class="type-card-title">Data Flow</div>
        <div class="desc" style="margin:0;">
          <code>PipelineProcessor</code> (background actor)<br>
          &nbsp;&rarr; calls <code>TrackManager.processFrame()</code><br>
          &nbsp;&rarr; maps <code>activeTracks</code> to <code>[TrackSnapshot]</code><br>
          &nbsp;&rarr; publishes to <code>PipelineService</code> (@MainActor)<br>
          &nbsp;&rarr; drives SwiftUI overlay rendering
        </div>
      </div>
    </div>

  </div></div>
</div>

<div class="flow"><div class="flow-line"></div><span class="flow-label" style="color:var(--yellow);opacity:0.6;">Phase 5 (planned)</span></div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L8: WORLD MODEL (PLANNED)                                 -->
<!-- ══════════════════════════════════════════════════════════ -->
<div class="layer planned" style="--layer-color: var(--yellow);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">3D</div>
    <div class="layer-info">
      <div class="layer-title">World Model <span class="planned-badge">Phase 5</span></div>
      <div class="layer-subtitle">protocol WorldModel &mdash; 3D reconstruction from decoded tracks + ARKit</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">Track + cameraTransform</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--yellow);">simd_float3</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="desc">
      Planned engine layer that triangulates LED 3D positions from multiple observations. Requires ARKit integration
      to provide <code>cameraTransform</code> with each frame. The <code>FrameData.cameraTransform</code> field already exists but is passed as <code>nil</code> today.
    </div>

    <div class="proto-block">
      <span class="cm">// SPEC.md &sect;7 &mdash; planned interface</span><br>
      <span class="kw">protocol</span> <span class="ty">WorldModel</span> {<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">recordObservation</span>(<br>
      &nbsp;&nbsp;&nbsp;&nbsp;ledID: <span class="ty">UInt16</span>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;pixelPosition: <span class="ty">CGPoint</span>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;cameraTransform: <span class="ty">simd_float4x4</span>,<br>
      &nbsp;&nbsp;&nbsp;&nbsp;timestamp: <span class="ty">TimeInterval</span><br>
      &nbsp;&nbsp;)<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">position</span>(<span class="pr">for</span> ledID: <span class="ty">UInt16</span>) -> <span class="ty">simd_float3</span>?<br>
      &nbsp;&nbsp;<span class="kw">var</span> <span class="pr">entries</span>: [<span class="ty">WorldEntry</span>] { <span class="kw">get</span> }<br>
      }
    </div>

    <div class="sub-label">Planned Capabilities</div>
    <div class="grid-2">
      <div class="type-card">
        <div class="type-card-title" style="color:var(--yellow);">ARKit Integration</div>
        <div class="desc" style="margin:0;">
          Replace <code>AVCaptureSession</code> with <code>ARSession</code> to get per-frame <code>simd_float4x4</code> camera transforms. Pre-decode observation buffer (ring buffer of recent frames) to capture observations retroactively once an LED is decoded.
        </div>
      </div>
      <div class="type-card">
        <div class="type-card-title" style="color:var(--yellow);">3D Reconstruction</div>
        <div class="desc" style="margin:0;">
          Multi-view triangulation (least-squares). Keyframe selection over dense storage.
          Catmull-Rom spline interpolation for LED string topology. Confidence gates and reflection filtering.
        </div>
      </div>
    </div>

  </div></div>
</div>

<!-- ══════════════════════════════════════════════════════════ -->
<!-- L9: TX SIDE (mini)                                        -->
<!-- ══════════════════════════════════════════════════════════ -->

<div style="margin-top:16px; padding-top:12px; border-top: 1px solid var(--border);">
  <div style="font-size:0.62rem; text-transform:uppercase; letter-spacing:0.12em; color:var(--text-dim); text-align:center; margin-bottom:10px;">Transmitter Side</div>
</div>

<div class="layer" style="--layer-color: var(--orange);" onclick="toggle(this)">
  <div class="layer-bar">
    <div class="layer-num">TX</div>
    <div class="layer-info">
      <div class="layer-title">LED Transmission</div>
      <div class="layer-subtitle">protocol LEDTransmitter &rarr; DDPNetworkDriver | MockScreenDriver</div>
    </div>
    <div class="layer-type-flow">
      <span class="t">SymbolEncoder</span>
      <span class="arrow">&rarr;</span>
      <span class="t" style="color:var(--orange);">LEDColor[ ]</span>
      <span class="arrow">&rarr;</span>
      <span class="t">DDP/Screen</span>
    </div>
    <div class="layer-chevron">&#x203A;</div>
  </div>
  <div class="layer-detail"><div class="layer-content">

    <div class="proto-block">
      <span class="kw">protocol</span> <span class="ty">LEDTransmitter</span>: <span class="ty">Sendable</span> {<br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">startTransmission</span>(ledCount: <span class="ty">UInt16</span>, encoder: <span class="ty">SymbolEncoder</span>, symbolRate: <span class="ty">Double</span>) <span class="kw">async</span><br>
      &nbsp;&nbsp;<span class="kw">func</span> <span class="fn">stopTransmission</span>()<br>
      }
    </div>

    <div class="grid-2">
      <div class="type-card">
        <div class="type-card-title">DDPNetworkDriver</div>
        <div class="desc" style="margin:0;">
          UDP transmission to WLED hardware. Pre-computes per-LED DDP packets. Symbol rate timing loop drives the flash sequence.
          Discovery via <code>WLEDDiscoveryService</code> (mDNS + JSON API).
        </div>
      </div>
      <div class="type-card">
        <div class="type-card-title">PLSRMock / MockScreenDriver</div>
        <div class="desc" style="margin:0;">
          macOS screen renderer for hardware-free testing. <code>DistractionEngine</code> adds timing jitter.
          <code>GlowConfig</code> simulates realistic LED light profiles with brightness falloff.
        </div>
      </div>
    </div>

  </div></div>
</div>

</div><!-- .diagram -->

<script>
function toggle(layer) {
  const wasExpanded = layer.classList.contains('expanded');

  // Close all layers
  document.querySelectorAll('.layer.expanded').forEach(l => {
    l.classList.remove('expanded');
  });

  // If it wasn't expanded, open it
  if (!wasExpanded) {
    layer.classList.add('expanded');
    // Scroll into view with some offset
    setTimeout(() => {
      const rect = layer.getBoundingClientRect();
      const offset = 80;
      if (rect.top < offset || rect.bottom > window.innerHeight) {
        window.scrollTo({
          top: window.scrollY + rect.top - offset,
          behavior: 'smooth'
        });
      }
    }, 50);
  }
}

function switchStrat(tab, group) {
  // Update tabs
  const parent = tab.parentElement;
  parent.querySelectorAll('.strat-tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');

  // Update panels
  const panels = tab.closest('.layer-content').querySelectorAll(`.strat-panel[data-group="${group}"]`);
  const idx = Array.from(parent.children).indexOf(tab);
  panels.forEach((p, i) => {
    p.classList.toggle('active', i === idx);
  });
}
</script>

</body>
</html>
